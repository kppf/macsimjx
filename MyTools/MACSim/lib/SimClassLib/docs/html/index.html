<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Sim: The Sim Class Library</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.8 -->
<div class="qindex"><a class="qindexHL" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>The <a class="el" href="class_sim.html">Sim</a> Class Library </h1>
<p>
<h2><a class="anchor" name="Introduction">
Introduction</a></h2>
This class library can be used to help generate S-Function binaries whilst using the C++ language. Although C++ is supported under the <code>mex</code> compiler (when used in conjunction with a C++ compiler such as Borland C++ or Microsoft visual C++) the interface is severly bogged down within its original C roots. This class library helps the user `break free' from the ties of the oringinal S-Function C templates.<h2><a class="anchor" name="Usage">
Usage</a></h2>
<h3><a class="anchor" name="inher_define">
Inheritance and Definitions</a></h3>
The main class is an abstract class called <a class="el" href="class_sim.html">Sim</a>. This class may be inherited from with the user's own simulation class. There are a number of pure virtual member functions which must be overloaded in the user's class to achieve compilation --- these will be discussed later.<p>
There are a few #defines that are required at the top of the users class file if the file is to be properly compiled into a usable S-Function. These #defines are:<p>
<ul>
<li><code>SIM_CLASS_NAME</code> &lt;<em>class_name&gt;</em> </li>
<li><code>SIM_FILE_NAME</code> &lt;<em>file_name</em> (minus extension)&gt; </li>
<li><code>SIM_CLASS_DECLARATION</code> (to be inserted directly before the class <em>declaration</em>) </li>
<li><code>SIM_CLASS_DEFINITION</code> (to be inserted directly before the class <em>definition</em>)</li>
</ul>
The position of the <code>SIM_CLASS_DECLARATION</code> and <code>SIM_CLASS_DEFINITION</code> defines are very important and it is suggested that they are placed at the top of the cpp file before any other includes. Because of the complicated compilation and linking order that takes place when compiling an S-Function, <a class="el" href="sim_8h.html">sim.h</a> has to be included <em>twice</em> --- Once before the class <em>declaration</em>, and once before the class <em>definition(s)</em>. It is suggested that a header file is used to abstract the declaration. If this is done then order of instructions will be as shown in the following example:<p>
An example of a header file follows:<p>
<code>example.h</code>: <div class="fragment"><pre><span class="preprocessor">    #ifndef __EXAMPLE_H__</span>
<span class="preprocessor"></span><span class="preprocessor">    #define __EXAMPLE_H__</span>
<span class="preprocessor"></span>   
<span class="preprocessor">    #include &lt;<a class="code" href="sim_8h.html">sim.h</a>&gt;</span>
   
   
    <span class="keyword">class </span>ExampleClass : <span class="keyword">public</span> <a class="code" href="class_sim.html">Sim</a>
    {
        <span class="keyword">private</span>:
                <span class="comment">// Interface Protocal</span>
                <a class="code" href="class_continuous_interface.html">ContinuousInterface</a> * m_if;
   
        <span class="keyword">public</span>:
                <span class="comment">// Constructor</span>
                ExampleClass(SimStruct *s);
                <span class="comment">// Destructor</span>
                <span class="keyword">virtual</span> ~ExampleClass();
   
                <span class="comment">// Declare Sim Functions</span>
                <span class="keyword">virtual</span> <span class="keywordtype">void</span> start();
                <span class="keyword">virtual</span> <span class="keywordtype">void</span> init_cond();
                <span class="keyword">virtual</span> <span class="keywordtype">void</span> update();
                <span class="keyword">virtual</span> <span class="keywordtype">void</span> derivative();
                <span class="keyword">virtual</span> <span class="keywordtype">void</span> output();
                <span class="keyword">virtual</span> <span class="keywordtype">void</span> terminate();
    };
   
<span class="preprocessor">    #endif // __EXAMPLE_H__</span>
</pre></div><p>
An example of the code that could define the class in <code>example.h</code> follows:<p>
<code>example.cpp</code> <div class="fragment"><pre>    <span class="comment">//--------------------------------------------------</span>
    <span class="comment">//            Compulsary Defines</span>
    <span class="comment">//--------------------------------------------------</span>
   
<span class="preprocessor">    #define SIM_CLASS_NAME      ExampleClass</span>
<span class="preprocessor"></span><span class="preprocessor">    #define SIM_FILE_NAME       example</span>
<span class="preprocessor"></span>   
    <span class="comment">//--------------------------------------------------</span>
    <span class="comment">//            Declare the Sim class</span>
    <span class="comment">//--------------------------------------------------</span>
   
<span class="preprocessor">    #define SIM_CLASS_DECLARATION</span>
<span class="preprocessor"></span><span class="preprocessor">    #include "example.h"</span>
   
    <span class="comment">//--------------------------------------------------</span>
    <span class="comment">//            Define the Sim class</span>
    <span class="comment">//--------------------------------------------------</span>
   
<span class="preprocessor">    #define SIM_CLASS_DEFINITION</span>
<span class="preprocessor"></span><span class="preprocessor">    #include &lt;<a class="code" href="sim_8h.html">sim.h</a>&gt;</span>
   
    <span class="comment">// Constructor</span>
    ExampleClass::ExampleClass(SimStruct *p_S) : <a class="code" href="class_sim.html">Sim</a>(p_S)
    {
        <span class="comment">// Register a new Interface with:</span>
                <span class="comment">// 1 input, 3 outputs and 1 state</span>
        m_if = addContinuousInterface(<span class="stringliteral">"My Interface"</span>, 1, 3, 1, 0);
    }
   
    <span class="comment">// Destructor</span>
    ExampleClass::~ExampleClass()
    {
    }
   
    <span class="keywordtype">void</span> <a class="code" href="class_sim.html#a2">ExampleClass::start</a>()
    {
    }
   
    <span class="keywordtype">void</span> <a class="code" href="class_sim.html#a3">ExampleClass::init_cond</a>()
    {
        <span class="comment">// Set initial contition of state</span>
        m_if-&gt;x(0) = 0;
    }
   
    <span class="keywordtype">void</span> <a class="code" href="class_sim.html#a4">ExampleClass::update</a>()
    {
    }
   
    <span class="keywordtype">void</span> <a class="code" href="class_sim.html#a5">ExampleClass::derivative</a>()
    {
        <span class="comment">// Put input into dx for integration</span>
        m_if-&gt;dx(0) = m_if-&gt;u(0);
    }
   
    <span class="keywordtype">void</span> <a class="code" href="class_sim.html#a6">ExampleClass::output</a>()
    {
        <span class="comment">// First output a direct copy of input</span>
        m_if-&gt;y(0) = m_if-&gt;u(0);
   
        <span class="comment">// Second output a multiple of input</span>
        m_if-&gt;y(1) = 3 * m_if-&gt;u(0);
   
        <span class="comment">// Third output the integral of the input</span>
        m_if-&gt;y(2) = m_if-&gt;x(0);
    }
   
    <span class="keywordtype">void</span> <a class="code" href="class_sim.html#a7">ExampleClass::terminate</a>()
    {
    }
</pre></div><p>
Note the use of <code>SIM_CLASS_DECLARATION</code> and <code>SIM_CLASS_DEFINITION</code> in the above files. After each <code>#define</code> is written the <code><a class="el" href="sim_8h.html">sim.h</a></code> file is included. This file must be included after the <code>#define</code> commands as it is important for the <code><a class="el" href="sim_8h.html">sim.h</a></code> file to know the circumstance under which it is being included. Note also that the <code>SIM_CLASS_DECLARATION</code> <em>must</em> be included <em>before</em> the <code>SIM_CLASS_DEFINITION</code> (although, this is fairly obvious if you think about it!).<h3><a class="anchor" name="ios">
Inputs and Outputs</a></h3>
The ExampleClass above uses 1 input, 3 outputs and 1 state. It obtains these IOs by `requesting' a new `ContinuousInterface' using the command <a class="el" href="class_sim.html#a10">Sim.addContinuousInterface()</a>:<p>
<div class="fragment"><pre>        m_ip = addContinuousInterface(<span class="stringliteral">"My Interface"</span>, 1, 3, 1, 0); <span class="comment">// 1 input, 3 outputs and 1 state</span>
</pre></div><p>
The member variable m_if is a pointer to a <a class="el" href="class_continuous_interface.html">ContinuousInterface</a> class. The <a class="el" href="class_sim.html#a10">Sim.addContinuousInterface()</a> function returns a pointer to the newly created interface, and can then be used to access the IOs requested. The <a class="el" href="class_continuous_interface.html">ContinuousInterface</a> class has 5 main member functions to access the IOs:<p>
<ul>
<li>ContinuousInterface.u(unsigned int index) - To access the inputs </li>
<li>ContinuousInterface.y(unsigned int index) - To access the outputs </li>
<li>ContinuousInterface.x(unsigned int index) - To access the states </li>
<li>ContinuousInterface.dx(unsigned int index) - To access the state derivatives </li>
<li>ContinuousInterface.param(unsigned int index) - To access the S-Function parameters</li>
</ul>
In the above example, the three outputs are used to output:<p>
<ol>
<li>The first output is a direct copy of the input signal.</li><li>The second output is an amplification (by a factor of 3) of the input signal.</li><li>The third output is that of the single state we are using. The state derivative of which is given by the input in ExampleClass::derivative(). The third output is therefore the integral of the input.</li></ol>
<h3><a class="anchor" name="memb_funcs">
Compulsary Member Functions</a></h3>
There are a number of member functions that are declared as pure virtual in class <a class="el" href="class_sim.html">Sim</a>. These functions will have to defined in the users own simulation class. These functions are:<p>
<ul>
<li>start()</li><li>init_cond()</li><li>update()</li><li>derivative()</li><li>output()</li><li>terminate()</li></ul>
<p>
These functions are designed to mimic the behaviour of thier original S-Function counterparts:<p>
<ul>
<li>mdlStart()</li><li>mdlInitializeConditions()</li><li>mdlUpdate()</li><li>mdlDerivatives()</li><li>mdlOutputs()</li><li>mdlTerminate()</li></ul>
<p>
It is advised that the user reads the documentation in the Matlab literature to obtain an understanding of when these functions are called, and what operations to perform with each function.<h2><a class="anchor" name="Compilation">
Compilation</a></h2>
The code for all the relevant <a class="el" href="class_sim.html">Sim</a> classes are compiled into a library file called <code>sim.lib</code>. To compile your code it will need to be linked with <code>sim.lib</code>. For example, the <code>example.cpp</code> file listed above could be compiled using the following command on the matlab command prompt:<p>
<div class="fragment"><pre>    &gt;&gt; mex example.cpp sim.lib -v
</pre></div><p>
If compilation is successfull an <code>example.dll</code> file will be created for use within Simulink.<h2><a class="anchor" name="installation">
Installation</a></h2>
<h3><a class="anchor" name="matlab5">
Installing on MATLAB 5 with Borland 5.x compiler</a></h3>
To install the SimClassLib, download the SimClassLib folder to a suitable directory. Then navigate to <code>\Documents and Settings\&lt;user name&gt;\Application Data\Mathworks\MATLAB\</code> and open <code>mexopts.bat</code> in a text editor.<p>
Add the line <div class="fragment"><pre>    set SIMCLASSLIB=&lt;path to SimClassLib\code\&gt;
</pre></div>to the file just under the definition for the MATLAB path. For example: <div class="fragment"><pre>    rem ********************************************************************
    rem General parameters
    rem ********************************************************************
    set MATLAB=%MATLAB%
    set BORLAND=c:\Program Files\Borland\BCC55\
    set SIMCLASSLIB=c:\ltn100\Shared\SimClassLib\
    ...
</pre></div>On the line beginning <code>set INCLUDE=...</code>, add the following to the end: <div class="fragment"><pre>    ;%SIMCLASSLIB%\code\include
</pre></div>Finally, a bit further down add the following to the end of the line starting <code>set LINKFLAGS=...</code> <div class="fragment"><pre>    -L<span class="stringliteral">"%SIMCLASSLIB%\code\bin"</span>
</pre></div>The complete file should look something like this: <div class="fragment"><pre>    @echo off
    rem BCC53OPTS.BAT
    rem
    rem    Compile and link options used <span class="keywordflow">for</span> building MEX-files
    rem    with the Borland C compiler
    rem
    rem    $Revision: 1.2 $  $Date: 1998/12/30 18:59:07 $
    rem
    rem ********************************************************************
    rem General parameters
    rem ********************************************************************
    set MATLAB=%MATLAB%
    set BORLAND=c:\Program Files\Borland\BCC55\
    set SIMCLASSLIB=c:\ltn100\Shared\SimClassLib\
    set PATH=%BORLAND%\BIN;%MATLAB_BIN%;%PATH%
    set INCLUDE=%BORLAND%\INCLUDE;%SIMCLASSLIB%\code\include
    set LIB=%BORLAND%\LIB;%BORLAND%\LIB\32BIT
   
    rem ********************************************************************
    rem Compiler parameters
    rem ********************************************************************
    set COMPILER=bcc32
    set COMPFLAGS=-c -3 -P- -w- -pc -a8 -I<span class="stringliteral">"%INCLUDE%"</span> -DMATLAB_MEX_FILE
    set OPTIMFLAGS=-O2
    set DEBUGFLAGS=-v
    set NAME_OBJECT=-o
   
    rem ********************************************************************
    rem Library creation command
    rem ********************************************************************
    set PRELINK_CMDS1=copy <span class="stringliteral">"%MATLAB%\extern\include\_mex.def"</span> <span class="stringliteral">"%OUTDIR%%MEX_NAME%.def"</span>
    set PRELINK_CMDS2=implib -i %LIB_NAME%1.lib <span class="stringliteral">"%MATLAB%\extern\include\_matlab.def"</span>
    set PRELINK_CMDS3=implib -i %LIB_NAME%2.lib <span class="stringliteral">"%MATLAB%\extern\include\_libmatlbmx.def"</span>
    set PRELINK_DLLS=implib -i %DLL_NAME%.lib <span class="stringliteral">"%MATLAB%\extern\include\_%DLL_NAME%.def"</span>
   
    rem ********************************************************************
    rem Linker parameters
    rem ********************************************************************
    set LINKER=perl %MATLAB_BIN%\link_borland_mex.pl
    set LINKFLAGS=-aa -c -Tpd -x -Gn -L\<span class="stringliteral">"%BORLAND%"</span>\lib\32bit .... <span class="stringliteral">"%OUTDIR%%MEX_NAME%.def"</span> -L<span class="stringliteral">"%SIMCLASSLIB%\code\bin"</span>
    set LINKOPTIMFLAGS=
    set LINKDEBUGFLAGS=-v
    set LINK_FILE=
    set LINK_LIB=
    set NAME_OUTPUT=<span class="stringliteral">"%OUTDIR%%MEX_NAME%"</span>.dll
    set RSP_FILE_INDICATOR=@
   
    rem ********************************************************************
    rem Resource compiler parameters
    rem ********************************************************************
    set RC_COMPILER=brcc32 -w32 -D_NO_VCL -fomexversion.res
    set RC_LINKER=
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Mar 9 15:36:28 2005 for Sim by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.8 </small></address>
</body>
</html>
