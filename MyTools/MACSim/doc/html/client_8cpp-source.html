<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>MACSim Library: MACSim/client/src/client.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">MACSim</a>&nbsp;/&nbsp;<a class="el" href="dir_000001.html">client</a>&nbsp;/&nbsp;<a class="el" href="dir_000006.html">src</a></div>
<h1>client.cpp</h1><a href="client_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">//----------------------------------------------------------------------------</span>
00002 <span class="comment">// client.cpp</span>
00003 <span class="comment">//</span>
00004 <span class="comment">// Project : Multi-Agent Control in a Simulink block</span>
00005 <span class="comment">// File    : Client interface functions</span>
00006 <span class="comment">//</span>
00007 <span class="comment">// Version : 1.0</span>
00008 <span class="comment">// Date    : 6th February 2005</span>
00009 <span class="comment">// Author  : Peter Mendham</span>
00010 <span class="comment">//</span>
00011 <span class="comment">// (c) University of York</span>
00012 <span class="comment">//----------------------------------------------------------------------------</span>
00013 
00014 <span class="preprocessor">#include &lt;windows.h&gt;</span>
00015 
00016 <span class="preprocessor">#include "../include/client.h"</span>
00017 
00018 <span class="comment">//----------------------------------------------------------------------------</span>
00019 <span class="comment">// Generic pipe open</span>
00020 <span class="comment">//----------------------------------------------------------------------------</span>
00021 
<a name="l00022"></a><a class="code" href="class_client.html#b0">00022</a> HANDLE <a class="code" href="class_client.html#b0">Client::openPipe</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* pipeName)<span class="keyword"> const</span>
00023 <span class="keyword"></span>{
00024         HANDLE hPipe;
00025         DWORD dwMode;
00026         BOOL fSuccess;
00027 
00028         <span class="keywordflow">do</span>
00029         {
00030                 <span class="comment">// Open pipe connection with mac server</span>
00031                 hPipe = CreateFile(
00032                         (LPTSTR)pipeName,               <span class="comment">// pipe name</span>
00033                         GENERIC_READ |                  <span class="comment">// read and write access</span>
00034                         GENERIC_WRITE,                  <span class="comment">//</span>
00035                         0,                              <span class="comment">// no sharing</span>
00036                         NULL,                           <span class="comment">// no security attributes</span>
00037                         OPEN_EXISTING,                  <span class="comment">// opens existing pipe</span>
00038                         0,                              <span class="comment">// default attributes</span>
00039                         NULL);                          <span class="comment">// no template file</span>
00040 
00041                 <span class="comment">// If we connected, set the pipe mode</span>
00042                 <span class="keywordflow">if</span> (hPipe != INVALID_HANDLE_VALUE)
00043                 {
00044                         <span class="comment">// Set the pipe mode to message read</span>
00045                         dwMode = PIPE_READMODE_MESSAGE;
00046                         fSuccess = SetNamedPipeHandleState(
00047                                 hPipe,                          <span class="comment">// pipe handle</span>
00048                                 &amp;dwMode,                        <span class="comment">// new pipe mode</span>
00049                                 NULL,                           <span class="comment">// don't set maximum bytes</span>
00050                                 NULL);                          <span class="comment">// don't set maximum time</span>
00051 
00052                         <span class="comment">// Check for success</span>
00053                         <span class="keywordflow">if</span> (!fSuccess)
00054                         {
00055                                 CloseHandle(hPipe);
00056                                 <span class="keywordflow">return</span> INVALID_HANDLE_VALUE;
00057                         }
00058                 } 
00059                 <span class="keywordflow">else</span>
00060                 {
00061                         <span class="comment">// We didn't connect, handle the error</span>
00062                         <span class="keywordflow">switch</span> (GetLastError())
00063                         {
00064                                 <span class="keywordflow">case</span> ERROR_PIPE_BUSY:
00065                                 
00066                                         <span class="keywordflow">if</span> (!WaitNamedPipe(pipeName, NMPWAIT_USE_DEFAULT_WAIT))
00067                                                 <span class="keywordflow">throw</span> <a class="code" href="class_client_exception.html">ClientException</a>(<span class="stringliteral">"openPipe: Cannot connect, pipe is busy"</span>);
00068                                         <span class="keywordflow">break</span>;
00069                                         
00070                                 <span class="keywordflow">case</span> ERROR_FILE_NOT_FOUND:
00071                                 <span class="keywordflow">case</span> ERROR_PATH_NOT_FOUND:
00072                                 
00073                                         <span class="keywordflow">throw</span> <a class="code" href="class_client_exception.html">ClientException</a>(<span class="stringliteral">"openPipe: Cannot connect, pipe not present"</span>);
00074                                         
00075                                 <span class="comment">// REMOVE THIS WHEN ALL EXCEPTIONS ARE HANDLED</span>
00076                                 <span class="keywordflow">default</span>:
00077                                 
00078                                         <span class="keywordflow">throw</span> <a class="code" href="class_client_exception.html">ClientException</a>(<span class="stringliteral">"openPipe: Cannot connect, unknown error"</span>);
00079                         }
00080                 }
00081 
00082         } <span class="keywordflow">while</span> (hPipe == INVALID_HANDLE_VALUE);
00083 
00084         <span class="keywordflow">return</span> hPipe;
00085 }
00086 
00087 <span class="comment">//----------------------------------------------------------------------------</span>
00088 <span class="comment">// Generic configuration pipe data request</span>
00089 <span class="comment">//----------------------------------------------------------------------------</span>
00090 
<a name="l00091"></a><a class="code" href="class_client.html#b1">00091</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="class_client.html#b1">Client::configDataRequest</a>(HANDLE hPipe, DWORD dwMsg)<span class="keyword"> const</span>
00092 <span class="keyword"></span>{
00093         DWORD dwReply, cbWritten, cbRead;
00094         BOOL fSuccess;
00095 
00096         <span class="comment">// Write request to pipe</span>
00097         fSuccess = WriteFile(
00098                 hPipe,                  <span class="comment">// pipe handle</span>
00099                 &amp;dwMsg,                 <span class="comment">// message</span>
00100                 <span class="keyword">sizeof</span>(dwMsg),          <span class="comment">// message length</span>
00101                 &amp;cbWritten,             <span class="comment">// bytes written</span>
00102                 NULL);                  <span class="comment">// not overlapped</span>
00103 
00104         <span class="comment">// Check for success</span>
00105         <span class="keywordflow">if</span> (!fSuccess || cbWritten != <span class="keyword">sizeof</span>(dwMsg))
00106                 <span class="keywordflow">throw</span> <a class="code" href="class_client_exception.html">ClientException</a>(<span class="stringliteral">"configDataRequest: Unable to write to pipe"</span>);
00107 
00108         <span class="comment">// Attempt to read response from pipe</span>
00109         fSuccess = ReadFile(
00110                 hPipe,                                  <span class="comment">// pipe handle</span>
00111                 &amp;dwReply,                               <span class="comment">// buffer to receive reply</span>
00112                 <span class="keyword">sizeof</span>(dwReply),                <span class="comment">// size of buffer</span>
00113                 &amp;cbRead,                                <span class="comment">// number of bytes read</span>
00114                 NULL);                                  <span class="comment">// not overlapped</span>
00115 
00116         <span class="comment">// Check for success</span>
00117         <span class="keywordflow">if</span> (!fSuccess || cbRead != <span class="keyword">sizeof</span>(dwReply))
00118                 <span class="keywordflow">throw</span> <a class="code" href="class_client_exception.html">ClientException</a>(<span class="stringliteral">"configDataRequest: Unable to read from pipe"</span>);
00119         
00120         <span class="comment">// Check for invalid response</span>
00121         <span class="keywordflow">if</span> (dwReply == (DWORD)<a class="code" href="interface_8h.html#a5">MAC_INVALID_RETURN</a>)
00122                 <span class="keywordflow">throw</span> <a class="code" href="class_client_exception.html">ClientException</a>(<span class="stringliteral">"configDataRequest: Invalid response code"</span>);
00123 
00124         <span class="keywordflow">return</span> dwReply;
00125 }
00126 
00127 <span class="comment">//----------------------------------------------------------------------------</span>
00128 <span class="comment">// Request data from a pipe with pipe open</span>
00129 <span class="comment">//----------------------------------------------------------------------------</span>
00130 
<a name="l00131"></a><a class="code" href="class_client.html#b2">00131</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="class_client.html#b1">Client::configDataRequest</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* pipeName, DWORD msgId)<span class="keyword"> const</span>
00132 <span class="keyword"></span>{
00133         HANDLE hConfigPipe;
00134         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> response;
00135         
00136         <span class="comment">// Open pipe</span>
00137         hConfigPipe = <a class="code" href="class_client.html#b0">openPipe</a>(pipeName);
00138         
00139         <span class="comment">// Perform the request</span>
00140         response = <a class="code" href="class_client.html#b1">configDataRequest</a>(hConfigPipe, msgId);
00141         
00142         <span class="comment">// Close the pipe</span>
00143         CloseHandle(hConfigPipe);
00144         
00145         <span class="comment">// Return response</span>
00146         <span class="keywordflow">return</span> response;
00147 }
00148 
00149 
00150 <span class="comment">//----------------------------------------------------------------------------</span>
00151 <span class="comment">// Initialise member data from configuration pipe if requested</span>
00152 <span class="comment">//----------------------------------------------------------------------------</span>
00153 
<a name="l00154"></a><a class="code" href="class_client.html#b3">00154</a> <span class="keywordtype">void</span> <a class="code" href="class_client.html#b3">Client::initialise</a>(BOOL cacheData)
00155 {
00156         HANDLE hConfigPipe;
00157         
00158         <span class="comment">// Haven't opened simulation pipe yet</span>
00159         <a class="code" href="class_client.html#z2_0">m_simPipe</a> = INVALID_HANDLE_VALUE;
00160         
00161         <span class="comment">// Data not cached yet</span>
00162         <a class="code" href="class_client.html#r0">m_dataCached</a> = FALSE;
00163         
00164         <span class="comment">// Request data, if we've been asked</span>
00165         <span class="keywordflow">if</span> (cacheData)
00166         {
00167                 <span class="comment">// Open configuration pipe</span>
00168                 hConfigPipe = <a class="code" href="class_client.html#b0">openPipe</a>(<a class="code" href="interface_8h.html#a0">MAC_CONFIG_PIPE_NAME</a>);
00169 
00170                 <span class="comment">// Request configuration data</span>
00171                 <a class="code" href="class_client.html#z2_1">m_inputs</a> = <a class="code" href="class_client.html#b1">configDataRequest</a>(hConfigPipe, <a class="code" href="interface_8h.html#a2">MAC_CONFIG_CMD_INPUTS</a>);
00172                 <a class="code" href="class_client.html#z2_2">m_outputs</a> = <a class="code" href="class_client.html#b1">configDataRequest</a>(hConfigPipe, <a class="code" href="interface_8h.html#a3">MAC_CONFIG_CMD_OUTPUTS</a>);
00173                 <a class="code" href="class_client.html#z2_3">m_sampleInterval</a> = <a class="code" href="class_client.html#b1">configDataRequest</a>(hConfigPipe, <a class="code" href="interface_8h.html#a4">MAC_CONFIG_CMD_SAMPLE</a>);
00174 
00175                 <span class="comment">// Close configuration pipe</span>
00176                 CloseHandle(hConfigPipe);
00177 
00178                 <span class="comment">// Open simulation pipe</span>
00179                 <a class="code" href="class_client.html#z2_0">m_simPipe</a> = <a class="code" href="class_client.html#b0">openPipe</a>(<a class="code" href="interface_8h.html#a1">MAC_SIM_PIPE_NAME</a>);
00180                 
00181                 <span class="comment">// We have cached all data</span>
00182                 <a class="code" href="class_client.html#r0">m_dataCached</a> = TRUE;
00183         }
00184 }
00185 
00186 <span class="comment">//----------------------------------------------------------------------------</span>
00187 <span class="comment">// Destructor</span>
00188 <span class="comment">//----------------------------------------------------------------------------</span>
00189 
<a name="l00190"></a><a class="code" href="class_client.html#a2">00190</a> <a class="code" href="class_client.html#a2">Client::~Client</a>()
00191 {
00192         <span class="comment">// Close simulation pipe</span>
00193         <span class="keywordflow">if</span> (<a class="code" href="class_client.html#z2_0">m_simPipe</a> != INVALID_HANDLE_VALUE)
00194                 CloseHandle(<a class="code" href="class_client.html#z2_0">m_simPipe</a>);
00195 }
00196 
00197 <span class="comment">//----------------------------------------------------------------------------</span>
00198 <span class="comment">// Get outputs for this time interval from simulation pipe</span>
00199 <span class="comment">//----------------------------------------------------------------------------</span>
00200 
<a name="l00201"></a><a class="code" href="class_client.html#z5_0">00201</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="class_client.html#z5_0">Client::getSimOutputs</a>(<a class="code" href="class_i_o_packet.html">IOPacket</a>* in, <a class="code" href="class_i_o_packet.html">IOPacket</a>* out)<span class="keyword"> const</span>
00202 <span class="keyword"></span>{
00203         DWORD cbWritten, cbRead, size;
00204         HANDLE hSimPipe = <a class="code" href="class_client.html#z2_0">m_simPipe</a>;
00205         BOOL fSuccess;
00206         
00207         <span class="comment">// Open simulation pipe if necessary</span>
00208         <span class="keywordflow">if</span> (!<a class="code" href="class_client.html#r0">m_dataCached</a>)
00209                 hSimPipe = <a class="code" href="class_client.html#b0">openPipe</a>(<a class="code" href="interface_8h.html#a1">MAC_SIM_PIPE_NAME</a>);
00210 
00211         <span class="comment">// Write request to pipe</span>
00212         size = in-&gt;m_nValues * <span class="keyword">sizeof</span>(double);
00213         fSuccess = WriteFile(
00214                 hSimPipe,                               <span class="comment">// pipe handle</span>
00215                 in-&gt;m_values,           <span class="comment">// message</span>
00216                 size,                                   <span class="comment">// size of buffer</span>
00217                 &amp;cbWritten,             <span class="comment">// number of bytes written</span>
00218                 NULL);                  <span class="comment">// not overlapped</span>
00219 
00220         <span class="comment">// Check for success</span>
00221         <span class="keywordflow">if</span> (!fSuccess || cbWritten != size)
00222         {
00223                 <span class="comment">// Close simulation pipe if necessary</span>
00224                 <span class="keywordflow">if</span> (!<a class="code" href="class_client.html#r0">m_dataCached</a>)
00225                         CloseHandle(hSimPipe);
00226                 
00227                 <span class="comment">// Throw exception</span>
00228                 <span class="keywordflow">throw</span> <a class="code" href="class_client_exception.html">ClientException</a>(<span class="stringliteral">"getSimOutputs: Unable to write to pipe"</span>);
00229         }
00230 
00231         <span class="comment">// Attempt to read response from pipe</span>
00232         size = out-&gt;m_nValues * <span class="keyword">sizeof</span>(double);
00233         fSuccess = ReadFile(
00234                 hSimPipe,                               <span class="comment">// pipe handle</span>
00235                 out-&gt;m_values,                  <span class="comment">// buffer to receive reply</span>
00236                 size,                                   <span class="comment">// size of buffer</span>
00237                 &amp;cbRead,                                <span class="comment">// number of bytes read</span>
00238                 NULL);                                  <span class="comment">// not overlapped</span>
00239 
00240         <span class="comment">// Check for success</span>
00241         <span class="keywordflow">if</span> (!fSuccess || cbRead != size)
00242         {
00243                 <span class="comment">// Close simulation pipe if necessary</span>
00244                 <span class="keywordflow">if</span> (!<a class="code" href="class_client.html#r0">m_dataCached</a>)
00245                         CloseHandle(hSimPipe);
00246                 
00247                 <span class="comment">// Throw exception</span>
00248                 <span class="keywordflow">throw</span> <a class="code" href="class_client_exception.html">ClientException</a>(<span class="stringliteral">"getSimOutputs: Unable to read from pipe"</span>);
00249         }
00250 
00251         <span class="comment">// Close simulation pipe if necessary</span>
00252         <span class="keywordflow">if</span> (!<a class="code" href="class_client.html#r0">m_dataCached</a>)
00253                 CloseHandle(hSimPipe);
00254                 
00255         <span class="keywordflow">return</span> out-&gt;m_nValues;
00256 }
00257 
00258 <span class="comment">//----------------------------------------------------------------------------</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Mar 9 16:07:32 2005 for MACSim Library by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.1 </small></address>
</body>
</html>
