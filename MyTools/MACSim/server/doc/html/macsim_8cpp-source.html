<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>MACSim Server: MACSim/server/src/macsim.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">MACSim</a>&nbsp;/&nbsp;<a class="el" href="dir_000002.html">server</a>&nbsp;/&nbsp;<a class="el" href="dir_000006.html">src</a></div>
<h1>macsim.cpp</h1><a href="macsim_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">//----------------------------------------------------------------------------</span>
00002 <span class="comment">// MACSim.cpp</span>
00003 <span class="comment">//</span>
00004 <span class="comment">// Project : Multi-Agent Control in a Simulink block</span>
00005 <span class="comment">// File    : MACSimServer class implementation</span>
00006 <span class="comment">//</span>
00007 <span class="comment">// Version : 1.0</span>
00008 <span class="comment">// Date    : 9th February 2005</span>
00009 <span class="comment">// Author  : Peter Mendham</span>
00010 <span class="comment">//</span>
00011 <span class="comment">// (c) University of York</span>
00012 <span class="comment">//----------------------------------------------------------------------------</span>
00013 
00014 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00015 <span class="preprocessor">#include &lt;conio.h&gt;</span>
00016 
00017 <span class="preprocessor">#include "../include/macsim.h"</span>
00018 
00019 <span class="comment">//----------------------------------------------------------------------------</span>
00020 <span class="comment">// Config Server Function</span>
00021 <span class="comment">//----------------------------------------------------------------------------</span>
00022 
<a name="l00023"></a><a class="code" href="class_config_server.html#b0">00023</a> <span class="keywordtype">void</span> <a class="code" href="class_config_server.html#b0">ConfigServer::serverFunc</a>(<span class="keywordtype">void</span>* request, <span class="keywordtype">void</span>* reply)
00024 {
00025         DWORD requestCode = *((DWORD*)request);
00026         DWORD* replyPtr = (DWORD*)reply;
00027         
00028         <span class="comment">// Pass on requests to the interface</span>
00029         <span class="keywordflow">switch</span> (requestCode)
00030         {       
00031         <span class="keywordflow">case</span> <a class="code" href="interface_8h.html#a2">MAC_CONFIG_CMD_INPUTS</a>:
00032                 *replyPtr = <a class="code" href="class_config_server.html#p0">m_interface</a>-&gt;<a class="code" href="class_m_a_c_sim_server_interface.html#z2_0">getNumInputs</a>();
00033                 <span class="keywordflow">break</span>;
00034 
00035         <span class="keywordflow">case</span> <a class="code" href="interface_8h.html#a3">MAC_CONFIG_CMD_OUTPUTS</a>:
00036                 *replyPtr = <a class="code" href="class_config_server.html#p0">m_interface</a>-&gt;<a class="code" href="class_m_a_c_sim_server_interface.html#z2_1">getNumOutputs</a>();
00037                 <span class="keywordflow">break</span>;
00038 
00039         <span class="keywordflow">case</span> <a class="code" href="interface_8h.html#a4">MAC_CONFIG_CMD_SAMPLE</a>:
00040                 *replyPtr = <a class="code" href="class_config_server.html#p0">m_interface</a>-&gt;<a class="code" href="class_m_a_c_sim_server_interface.html#z2_2">getSampleInterval</a>();
00041                 <span class="keywordflow">break</span>;
00042 
00043         <span class="keywordflow">default</span>:
00044                 *replyPtr = <a class="code" href="interface_8h.html#a5">MAC_INVALID_RETURN</a>;
00045         }
00046 }
00047 
00048 <span class="comment">//----------------------------------------------------------------------------</span>
00049 <span class="comment">// Sim Server Function</span>
00050 <span class="comment">//----------------------------------------------------------------------------</span>
00051 
<a name="l00052"></a><a class="code" href="class_sim_server.html#b0">00052</a> <span class="keywordtype">void</span> <a class="code" href="class_sim_server.html#b0">SimServer::serverFunc</a>(<span class="keywordtype">void</span>* request, <span class="keywordtype">void</span>* reply)
00053 {
00054         ColumnVectorAliasConstant inputs((<span class="keywordtype">double</span>*)request, <a class="code" href="class_sim_server.html#p0">m_interface</a>-&gt;<a class="code" href="class_m_a_c_sim_server_interface.html#z2_0">getNumInputs</a>());
00055         ColumnVectorAlias outputs((<span class="keywordtype">double</span>*)reply, <a class="code" href="class_sim_server.html#p0">m_interface</a>-&gt;<a class="code" href="class_m_a_c_sim_server_interface.html#z2_1">getNumOutputs</a>());
00056         
00057         <span class="comment">// Pass on the request to the interface</span>
00058         <a class="code" href="class_sim_server.html#p0">m_interface</a>-&gt;<a class="code" href="class_m_a_c_sim_server_interface.html#z3_0">getSimOutputs</a>(inputs, outputs);
00059 }
00060 
00061 <span class="comment">//----------------------------------------------------------------------------</span>
00062 <span class="comment">// Constructor</span>
00063 <span class="comment">//----------------------------------------------------------------------------</span>
00064 
<a name="l00065"></a><a class="code" href="class_m_a_c_sim_server.html#a0">00065</a> <a class="code" href="class_m_a_c_sim_server.html#a0">MACSimServer::MACSimServer</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* p_name, <a class="code" href="class_m_a_c_sim_server_interface.html">MACSimServerInterface</a>* p_interface) :
00066                 m_name(p_name), m_isRunning(0), m_configServer(p_interface), m_simServer(p_interface)
00067 { }
00068 
00069 <span class="comment">//----------------------------------------------------------------------------</span>
00070 <span class="comment">// Run function</span>
00071 <span class="comment">//----------------------------------------------------------------------------</span>
00072 
<a name="l00073"></a><a class="code" href="class_m_a_c_sim_server.html#a2">00073</a> <span class="keywordtype">void</span> <a class="code" href="class_m_a_c_sim_server.html#a1">MACSimServer::run</a>(<span class="keywordtype">int</span> showMessage, <span class="keywordtype">int</span> waitForKey)
00074 {
00075         <span class="comment">// Run the system pipes</span>
00076         <a class="code" href="class_m_a_c_sim_server.html#p2">m_configServer</a>.<a class="code" href="class_thread.html#a2">run</a>();
00077         <a class="code" href="class_m_a_c_sim_server.html#p3">m_simServer</a>.<a class="code" href="class_thread.html#a2">run</a>();
00078         
00079         <span class="comment">// Running now</span>
00080         <a class="code" href="class_m_a_c_sim_server.html#p1">m_isRunning</a> = 1;
00081         
00082         <span class="keywordflow">if</span> (showMessage)
00083         {
00084                 <span class="comment">// Display server launch message</span>
00085                 printf(<span class="stringliteral">"MACSim Server: Running system \"%s\"\nPress any key to end service..."</span>, <a class="code" href="class_m_a_c_sim_server.html#p0">m_name</a>.c_str());
00086         }
00087 
00088         <span class="keywordflow">if</span> (waitForKey)
00089         {
00090                 <span class="comment">// Wait for key press</span>
00091                 <span class="keywordflow">if</span> (getch() == 0) {
00092                         getch();
00093                 }
00094                 
00095                 <span class="comment">// Terminate the server</span>
00096                 <a class="code" href="class_m_a_c_sim_server.html#a3">terminate</a>();
00097 
00098                 <span class="keywordflow">if</span> (showMessage)
00099                 {
00100                         <span class="comment">// Display final message</span>
00101                         printf(<span class="stringliteral">"done.\n"</span>);
00102                 }
00103         }
00104         
00105 }
00106         
00107 <span class="comment">//----------------------------------------------------------------------------</span>
00108 <span class="comment">// Terminate function</span>
00109 <span class="comment">//----------------------------------------------------------------------------</span>
00110 
<a name="l00111"></a><a class="code" href="class_m_a_c_sim_server.html#a3">00111</a> <span class="keywordtype">void</span> <a class="code" href="class_m_a_c_sim_server.html#a3">MACSimServer::terminate</a>()
00112 {
00113         <span class="comment">// Only attempt to terminate if the server is actually running</span>
00114         <span class="keywordflow">if</span> (<a class="code" href="class_m_a_c_sim_server.html#p1">m_isRunning</a>)
00115         {
00116                 <span class="comment">// Signal the system to terminate</span>
00117                 <a class="code" href="class_m_a_c_sim_server.html#p2">m_configServer</a>.<a class="code" href="class_thread.html#a3">terminate</a>();
00118                 <a class="code" href="class_m_a_c_sim_server.html#p3">m_simServer</a>.<a class="code" href="class_thread.html#a3">terminate</a>();
00119 
00120                 <span class="comment">// Not running any more</span>
00121                 <a class="code" href="class_m_a_c_sim_server.html#p1">m_isRunning</a> = 0;
00122         }
00123 }
00124 
00125 <span class="comment">//----------------------------------------------------------------------------</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Mar 9 15:53:43 2005 for MACSim Server by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.1 </small></address>
</body>
</html>
